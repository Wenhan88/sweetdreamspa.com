<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Panel - Sweet Dream Massage</title>
<link rel="stylesheet" href="style.css">

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="js/firebase.js"></script>
</head>

<body>
<header>
    <h1>Admin Panel</h1>
    <p>Manage reviews (only for authorized admin)</p >
</header>

<nav>
    <a href=" ">Home</a >
    <a href="services.html">Services</a >
    <a href="contact.html">Contact</a >
    <a href="rating.html">Rate Us</a >
    <a href="appointment.html">Appointment</a >
    <a href="admin.html">Admin</a >
</nav>

<div class="container">

    <!-- 登录区域 -->
    <div id="loginDiv">
        <h2>Admin Login</h2>
        <p>Only administrator can access this page.</p >
        <label>Email:</label>
        <input type="email" id="email" placeholder="Admin email">
        <label>Password:</label>
        <input type="password" id="password" placeholder="Password">
        <button onclick="login()">Login</button>
    </div>

    <!-- 管理面板 -->
    <div id="adminPanel" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
            <div>
                <h2>Reviews Management</h2>
                <p id="adminInfo"></p >
            </div>
            <button onclick="logout()">Logout</button>
        </div>

        <!-- 筛选条 -->
        <div style="margin: 10px 0; padding:10px; background:#f5f5f5; border-radius:6px;">
            <label>Min Rating:</label>
            <select id="minRating" style="max-width:120px;">
                <option value="1">1★ and up</option>
                <option value="2">2★ and up</option>
                <option value="3">3★ and up</option>
                <option value="4" selected>4★ and up</option>
                <option value="5">5★ only</option>
            </select>

            <label style="margin-left:15px;">Search Name:</label>
            <input type="text" id="searchName" placeholder="Type name..." style="max-width:200px;">
        </div>

        <div id="reviewsList"></div>
    </div>

</div>

<script>
const ADMIN_EMAIL = "shiwenhan0525@gmail.com";

let allReviews = []; // 保存所有评论，在前端做筛选

// 安全输出
function safe(text){
    return text ? text.replace(/</g,"&lt;").replace(/>/g,"&gt;") : "";
}

// 登录
function login(){
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;

    if(!email || !password){
        alert("Please enter email and password.");
        return;
    }

    auth.signInWithEmailAndPassword(email, password)
        .then(() => {
            const user = auth.currentUser;
            if(!user || user.email !== ADMIN_EMAIL){
                alert("You are not authorized to access this admin panel.");
                auth.signOut();
                return;
            }
            showAdminPanel(user);
            startReviewsListener();
        })
        .catch(err => alert("Login failed: " + err.message));
}

// 登出
function logout(){
    auth.signOut().then(()=>{
        document.getElementById("loginDiv").style.display = "block";
        document.getElementById("adminPanel").style.display = "none";
    });
}

// 显示后台
function showAdminPanel(user){
    document.getElementById("loginDiv").style.display = "none";
    document.getElementById("adminPanel").style.display = "block";
    document.getElementById("adminInfo").innerText =
        "Logged in as: " + (user.email || "");
}

// 监听 auth 状态
auth.onAuthStateChanged(user => {
    if(user && user.email === ADMIN_EMAIL){
        showAdminPanel(user);
        startReviewsListener();
    } else {
        document.getElementById("loginDiv").style.display = "block";
        document.getElementById("adminPanel").style.display = "none";
    }
});

// 启动评论监听
let unsubscribeReviews = null;
function startReviewsListener(){
    if(unsubscribeReviews){
        unsubscribeReviews();
    }
    unsubscribeReviews = db.collection("reviews")
        .orderBy("timestamp","desc")
        .onSnapshot(snapshot => {
            allReviews = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            renderReviews();
        });
}

// 渲染评论（根据筛选条件）
function renderReviews(){
    const minRating = parseInt(document.getElementById("minRating").value);
    const searchName = document.getElementById("searchName").value.trim().toLowerCase();
    const box = document.getElementById("reviewsList");
    box.innerHTML = "";

    const filtered = allReviews.filter(r => {
        const okRating = r.rating >= minRating;
        const okName = !searchName || (r.name && r.name.toLowerCase().includes(searchName));
        return okRating && okName;
    });

    if(filtered.length === 0){
        box.innerHTML = "<p>No reviews match current filters.</p >";
        return;
    }

    filtered.forEach(r => {
        const div = document.createElement("div");
        div.className = "review-card";
        const timeText = r.timestamp && r.timestamp.toDate
            ? r.timestamp.toDate().toLocaleString()
            : "";

        div.innerHTML = `
            <strong>${safe(r.name)} (${r.rating}★)</strong>
            <p>${safe(r.comment)}</p >
            <p style="font-size:12px;color:#777;">${timeText}</p >
            <button onclick="deleteReview('${r.id}')">Delete</button>
        `;
        box.appendChild(div);
    });
}

// 删除评论
function deleteReview(id){
    if(!confirm("Are you sure you want to delete this review?")) return;
    db.collection("reviews").doc(id).delete()
      .catch(err => alert("Delete failed: " + err.message));
}

// 监听筛选控件变化
document.getElementById("minRating").addEventListener("change", renderReviews);
document.getElementById("searchName").addEventListener("input", renderReviews);
</script>

</body>
</html>
